---
date: 2018-01-28 10:50
status: public
title: 源码阅读：MMPopupView
tags: iOS, 开发, 源码阅读
---

MMPopupView 源码阅读

<!--more-->

## 使用 MMPopupView

我们可以在 Demo 中看到它的使用方法

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0014/F2F3FC95-C8FF-48D9-AD96-69E2CB0B73B2.png)

* MMAlertView
* MMSheetView
* CustomView

前面两个是作者提供的两种默认实现，都继承自 `MMPopupView` 。使用者也可以根据业务需要，制作自己的 CustomView，也是继承 `MMPopupView` 即可。

## MMPopupView
这个库的弹窗（MMAlertView、MMSheetView、CustomView）都是继承自 `MMPopupView` 。它提供的属性有：

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0014/0FF12330-8DB9-4530-867B-61A561C6C88F.png)

提供的方法有：

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0014/AEA65404-21E2-4083-B48C-67EB6D8CDB87.png)

先从 MMPopupView 的初始化开始看起，可以发现，MMPopupView 的默认实现是 MMAlertView，MMSheetView 其实是在初始化后更改了自己的 type。属性 `attachedView` 默认是 `MMPopupWindow` ，这个一会再扩展，先继续阅读 MMPopupView 的方法。

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0014/3B7E07AC-3EEC-45FA-8DC6-C8F89E7C5BD0.png)

我把 MMPopupView 中的方法分成三类：

* show 相关
* hide 相关
* Animation 相关

按我们了解的相关方法设计规范，show 和 hide 都有它的最终调用方法。`showWithBlock` 和 `hideWithBlock`  。

Animation 是通过 Block 的方式调用的，这个 block 把 MMPopupView 对象重新传回去，在 block 中操作 self 对象。

类中提供了六种默认的动画实现。动画是在 `hideWithBlock` 的 block 完成之后才调用的。

## MMAlertView
API：

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0014/1F6C1F41-F8FE-4C24-85E8-0D2A64D75582.png)

所有方法实际上最终都使用同一个初始化方法：

```obj-c
- (instancetype)initWithTitle:(NSString *)title
                       detail:(NSString *)detail
                        items:(NSArray *)items
             inputPlaceholder:(NSString *)inputPlaceholder
                 inputHandler:(MMPopupInputHandler)inputHandler
```

这也符合多个 init 初始方法的设计规范。

这个类中的方法比较少，主要是：

* 初始化（包含 addSubView）
* showKeyboard、hideKeyBoard
* notify

这里讲一讲 MMAlertView 使用到比较特别的 API：

* UIView
	* `setContentCompressionResistancePriority forAxis`
	* `setContentHuggingPriority forAxis`

关于这两个 API 的扩展阅读：[iOS  AutoLayout中的Content Hugging 和 Content Comp… - 简书](https://www.jianshu.com/p/e38157d7b828)

* Masonry
	* `MASViewAttribute *lastAttribute = self.mas_top;`

另外还有另一个接口 MMAlertViewConfig，用来配置 AlerView 一些必要的信息：

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0014/2A47869B-6E7A-40AA-A502-3069E685A8C1.png)

`+ (MMAlertViewConfig *)globalConfig` 是一个全局的单例。

## MMSheetView
和 MMAlertView 相似，有一个 `MMSheetViewConfig` 。但是提供的初始化 API 只有一个

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0014/9389BF9E-34E2-413F-85BF-C1954FB1CAF8.png)

区别是没有 Detail、没法进行 input 以及 confirm 的默认实现（也就是说 MMSheetView 完全按照你输入的 item 进行变化）

## MMPopupWindow
MMPopupWindow 继承自 UIWindow，UIWindow 又继承自 UIView。当我们创建一个视图，并且希望该视图独立于其他 UI 层的时候，那么我们就可以使用 UIWindow。

在这个库中，MMPopupWindow 是 MMPopupView 的 super view。从 Reveal 我们可以看到它们的结构关系。

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0014/B889BE69-17F5-4D66-B2C5-183159B156DC.png)

MMPopupWindow 的方法有以下两类：

* 初始化与销毁
* 手势操作

属性 `attachView` 是 MMPopViewWindow 的根视图。每个 UIWindow 都有一个 `rootViewController` 属性。

## MMPopupView 的展示过程

这里主要讲一讲各个 View 是怎么被创建、添加、展示的。

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0014/48AD14F7-F7B5-4758-8787-DABD1DC2CF68.png)
MMAlertView UML

MMAlertView 继承自 MMPopupView，其中的 `attachedView` 指向 MMPopupWindow 对象。MMPopupWindow 对象将 MMPopupView 添加到自己上面，MMPopupView 负责添加 Item、Title 等。而将 MMPopupWindow 做为 KeyWindow 展示，是在 MMPopupView 中的 `showWithBlock` 的这句：`[self.attachedView mm_showDimBackground]`  ，这是使用了 `MMPopupCategory` 中的一个分类方法，下面讲解一下这个分类。

## MMPopupCategory

* UIColor (MMPopup)
* UIImage (MMPopup)
* UIButton (MMPopup)
* NSString (MMPopup)
* UIView (MMPopup)

### 比较简单的几个

UIColor、UIButton、NSString、UIImage的分类比较简单常见，功能如下：

* UIColor：`mm_colorWithHex` （使用十六进制 hex 转为 UIColor 对象）
* UIButton：`mm_buttonWithTarget:(id)target action:(SEL)sel` （添加 Button 的 Action）
* NSString：`mm_truncateByCharLength` （缩短字符串）
* UIImage：`mm_imageWithColor` （返回一张充满颜色的 UIImage）

### UIView

UIView 大量使用了 `objc_getAssociatedObject` 和 `objc_setAssociatedObject` 关联对象的方法。

简单说，关联对象是通过键给当前的对象绑定另一个对象，当我们需要读取或修改的时候又通过键的方式传递。关联对象一方向可以用来传递一些比较私密的 API，或者在回调的时候（Delegate 或 Block）作为取值的方式减少代码荣冗余，也可以用在为 Category 添加属性（Category 是不能新建 property 的。如果写了，编译器会警告，提示需要手写 set 和 get 方法）。

这里的 UIView 分类就是运用关联对象给 Category 添加属性的功能。

