---
date: 2017-11-21 15:40
status: public
title: MVVM、面向协议： MoSplash 的新尝试
tags: iOS, 开发, 设计模式
---

MoSplash 最近在做 Code Review 和 Refect，希望让它能够适应更多更大的需求。也是想把最近学习的知识应用上来。写这篇文章的目的，是想把重构的思路记录下来。

<!--more-->

## MVC 的原罪
入门 iOS 的同学都会被教育一套 MVC 的架构模型。MVC 是苹果鼓励使用的模型，它由下面三部分组成：

* Model：数据模型，负责模型管理
* Controller：控制器，负责逻辑处理
* View：视图，负责显示和响应

在 MVC 模型中，Controller 负责把从 Model 传递过来的数据进行逻辑处理，然后告诉 View 显示元素。Controller 也负责处理 View 的响应，处理逻辑后更新数据。

MVC 模型有一个很大的优点就是容易理解。也有一个人尽皆知的诟病，就是 Controller 的臃肿。MVVM 就是一个为 Controller 瘦身的模型思路。

## 了解 MVVM
在上一篇文章《[iOS 中「数据」的流动：从 JSON 到 MVVM](http://blog.ioshub.cn/2017/10/30/0012/)》中的最后，我对两种 Model View —— Data Source & Data Controller 的设计进行了简单的分析。Data Source 使用了 Protocol 的设计模式，将数据的逻辑从 View  Controller 分离并作为后者的 Data Source。而 Data Controller 则是封装了 View Controller 的数据逻辑，让后者持有前者，支持操作前者。

MVVM 在前两年就已经很火，网上对它的赞誉和对它的过誉的思考都有很多文章，这里就不过多累赘。放上几篇参考文章。

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0013/bg2015020110.png)


* [MVC，MVP 和 MVVM 的图示 - 阮一峰的网络日志](http://www.ruanyifeng.com/blog/2015/02/mvcmvp_mvvm.html)
* [被误解的MVC和被神化的MVVM](http://www.infoq.com/cn/articles/rethinking-mvc-mvvm)
* [猿题库 iOS 客户端架构设计 - Lancy’s Blog](http://gracelancy.com/blog/2016/01/06/ape-ios-arch-design/)
* [ObjC 中国- MVVM 介绍](https://objccn.io/issue-13-1/)


## MVVM in MoSplash 
我们思考对工程开始一种新的设计模式的时候，一定要理解这种设计模式在里面的应用和作用（积极与消极）。

MoSplash 在十一月之前采用都是基础的 MVC 和单继承的设计模式。而在应用，需要重复并且大量的展示图片的列表，过去的设计里代码复用性得不到提高，造成大量的重复和垃圾代码。

其实，我们只需要制造一个通用的 View Controller  让它的子类持有不同的 Data Controller，不同的 Data Controller 持有不同的 API，并为 VC 提供不同的数据源，就能让 View Controller 的代码实现了复用。

另外，可以用 Protocol 的模式，为每一个 Photo Data Controller 制定一组 Data Protocol，配合 Base Data Controller 的继承，可以加大代码的鲁棒性。Protocol 的设计是后话，我们后面再讲。

我们假设业务中需要一个 HomeViewController 的控件，它与架构中其他部分的关系如下图：

![](http://chanjh.b0.upaiyun.com/iOSHub/iOSHubBlog/0013/MS.png)

我们让 HomeViewController 持有了一个 MSPhotoListController。后者负责展示一个图片列表，拥有 ViewController 的逻辑，然而没有数据来源。于是 HomeViewController 为自己的 MSPhotoListController 指定了一个 HomeDataController。通过自定义 DataController 的方法，让列表显示不同内容。这就是上一篇文章中说的，让 VC 拥有 DC 的一种 MVVM 实现方式。

这里的 MSPhotoListController 就是 MoSplash 中通用的 ViewController，每一个需要使用它的组件，通过为它配制不同的 DC 的方式，让它显示不同的内容。为了让 Data Controller 更好适应业务，我为其设定了继承和协议两种约束。

```Objective-C
@implementation MSPhotoDataController

- (instancetype)init
{
    if(self = [super init])
    {
        if([self conformsToProtocol:@protocol(DataControllerProtocol)])
        {
			// init
        }
        else
        {
            NSException *exception = [[NSException alloc]initWithName:@"DataControllerProtocol Exception" reason:@"没有遵循DataControllerProtocol协议" userInfo:nil];
            @throw exception;
        }
    }
    return self;
}
@end
```

```Objective-C
@implementation MSPhotoListController
- (void)viewDidLoad
{
    [super viewDidLoad];
    if(![self.dataController.class isKindOfClass:[MSPhotoDataController class]]){
        // 抛出错误
    }
}
@end
```

## 面向协议 in  MoSplash

在 Data Controller in MoSplash 的设计里，协议和继承都是为了代码尽可能的实现复用，减少代码重复的同时，增加项目的鲁棒性。

在使用这两种模式实现代码复用之前，我们要先想清楚两者的区别。关于代码的复用，二者都不是万能的。在 MoSplash MVVM 设计中，继承为子类提供了主要方法的默认实现以及基本的数据对象，而 Protocol 的核心作用是让子类提供「配置信息」，从而向父类传递子类想要实现的效果。

```Objective-C
@protocol DataControllerProtocol

@required
/**
 * 用于查重的 Model 的属性名
 */
- (NSString *)sortPropertyName;

/**
 * Cache saved key
 */
- (NSString *)cacheKey;

/**
 * Get cache
 */
- (NSArray *)getCache;

@optional
/**
 * 可选方法
 * 用于缓存数据
 */
- (void)saveCache;
@end
```

```Objective-C
/* ----------------------------------------- */
/**
 * 数据加载的委托方法
 */
@protocol MSPhotoDataControllerDelegate<NSObject>

@optional

- (void)dataLoadWillStar;
- (void)dataLoadDidFinishedWithError:(NSError *)error;

@required

@end

/* ----------------------------------------- */
@interface MSPhotoDataController : NSObject
/**
 * 当前数据的 Page Index
 */
@property (nonatomic, assign) NSInteger curIndex;

@property (nonatomic, weak) id <MSPhotoDataControllerDelegate> delegate;

@property (nonatomic, weak, readonly) id<DataControllerProtocol> child;

/* ----------------------------------------- */
/**
 * 装配完成后的数组，可用于数据显示
 */
@property (nonatomic, copy) NSArray *modelArray;
/**
 * 数据请求完成后，得到的原始数组
 */
@property (nonatomic, copy) NSArray *rawModelArray;
/**
 *
 */
@property (nonatomic, strong) NSString *searchKeyword;

/* ----------------------------------------- */
/**
 * 根据页数加载新的数据
 * @param index 索引
 */
- (void)loadAtIndex:(NSUInteger)index;

/**
 * 根据页数和搜索关键字加载数据
 * @param index 索引
 * @param keyword 搜索关键字
 */
- (void)searchAtIndex:(NSUInteger)index
          withKeyword:(NSString *)keyword;


@end
```


## 结语

由于使用了 MVVM 重构了 MoSplash 项目，让原有几百行的类，减少到每个只有一百行甚至不到，让代码维护成本降低。当然，也带来一些问题，比较代码理解难度上升，这些问题可能可以通过书写文档的方式解决。

另外，面向协议的思想会加强类的鲁棒性，给予架构设计师一些很好的设计方向。


- - - -

更多个人分享，可以瞧瞧我不怎么更新的技术博客：[iOSHub](blog.ioshub.cn)。当然还有非技术的 [ChanTalk](zhuanlan.zhihu.com/chantalk)。